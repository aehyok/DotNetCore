
@{
    ViewBag.Title = "Personal";
}

<link href="../theme/assets/apps/css/inbox.min.css" rel="stylesheet" type="text/css" />

<script src="~/signalr-client.min.js"></script>

<script type="text/javascript">
    //聊天链接
    let hubConnection;
    $(function () {
        //建立链接
        let hubUrl = 'http://192.168.1.23:5004/chat?userName=aehyok';
        let httpConnection = new signalR.HttpConnection(hubUrl);
        hubConnection = new signalR.HubConnection(httpConnection);

        //1、进行握手
        hubConnection.start();

        //3、握手后的服务端回调Except
        hubConnection.on('OnConnectionedExcept', data => {
            $("#roomlist li").remove();
            for (var i = 0; i < data.length; i++)
            {
                AddChatUser(data[i].ContextId, data[i].Name);
            }
        });

        //3、握手后的服务端回调Me
        hubConnection.on('OnConnectionedMe', data => {

            var parameter = new Object();
            var userName = $("#UserIdentityName").html();
            parameter.ContextId = data;
            parameter.Name = userName;
            //4、链接建立后处理信息
            hubConnection.invoke('OnConnectionedAfter', parameter);
        });


        //断开链接监听事件
        hubConnection.on('OnDisconneted', data => {
            $("#Li" + data).parentNode.removeChild($("#Li" + data));
        });

        ////发送消息
        //$("#SendMessage").click(function () {
        //    hubConnection.invoke('SendMessage', $('#reportName').val());
        //});
    });
    //点击发送按钮并调用服务进行推送消息（此处注意SendMessage方法定义在Dashboard.js中）
    function SendMessage(message) {
        var contextId = $("#BtnSubmitMessage").attr("data-id");

        hubConnection.invoke('SendMessage', $('#reportName').val());
    }

    function OnDisconneted()
    {
        

    }


    function AddChatUser(connectionId,userName)
    {
        if ($("#ChatRoomName").val() == userName) {
            $("#BtnSubmitMessage").attr("data-id", connectionId);
        }
        var html = '<li id=\"li"+"' + connectionId + '\"><a href=\"javascript:void(0);\" onclick=\'AddRoom("' + connectionId + '","' + userName + '")\'><img class=\"contact-pic\" src=\"../theme/assets/pages/media/users/avatar7.jpg\">' +
            '<span class=\"contact-name\">' + userName + '</span>' +
            '<span class=\"contact-status bg-green\"></span></a></li>';
        $("#roomlist").append(html);
    }

    //与指定联系人建立显示聊天窗口
    function AddRoom(contextId, name) {
        $("#ChatRoomName").html(name);
        $("#BtnSubmitMessage").attr("data-id", contextId);
        var cont = $('#chats');
        var list = $('.chats', cont);
        list.find("li").remove();
    }
</script>

<div style="display: none;">
    <div class="row">
        <div style="float: left;">名称:</div>
        <div style="float: left;" id="UserName">@User.Identity.Name</div>
        <div>用户唯一编码:<p id="ConID"></p></div>
    </div>
</div>
<div class="row">
    <div class="col-md-2">
        <div class="inbox">
            <div class="inbox-sidebar">
                <a href="javascript:;" data-title="Compose" class="btn red compose-btn btn-block">
                    <i class="fa "></i> 通讯录列表
                </a>
                <ul class="inbox-contacts" id="roomlist">
                    @*<li>
                        @{
                            foreach (var item in Model)
                            {
                                <a href="javascript:void(0);">
                                    <img class="contact-pic\" src="../theme/assets/pages/media/users/avatar7.jpg">
                                    <span class="contact-name\">@item.UserName</span>
                                    <span class="contact-status bg-green"></span>
                                </a>
                            }
                        }

                    </li>*@
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-10">
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="portlet light ">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="icon-bubble font-red-sunglo"></i>
                            <span class="caption-subject font-red-sunglo bold uppercase" id="ChatRoomName">Chats</span>
                        </div>
                    </div>
                    <div class="portlet-body" id="chats">
                        <div class="scroller" style="height: 385px;" data-always-visible="1" data-rail-visible="0">
                            <ul class="chats"></ul>
                        </div>
                        <div class="chat-form">
                            <div class="input-cont">
                                <input class="form-control" type="text" placeholder="Type a message here..." />
                            </div>
                            <div class="btn-cont">
                                <span class="arrow"> </span>
                                <a href="" class="btn blue icn-only" data-id="1" id="BtnSubmitMessage">
                                    <i class="fa fa-check icon-white"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



